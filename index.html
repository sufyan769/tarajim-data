<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>البداية والنهاية - التاريخ الكبير</title>

  <!-- Tailwind CSS (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Babel for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=Noto+Naskh+Arabic:wght@400;700&display=swap"
    rel="stylesheet">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['"Noto Naskh Arabic"', 'sans-serif'],
            serif: ['"Amiri"', 'serif'],
          },
          colors: {
            'wiki-bg': '#f8f9fa',
            'wiki-border': '#a2a9b1',
            'wiki-link': '#0645ad',
            'wiki-link-visited': '#0b0080',
            'wiki-text': '#202122',
            'wiki-panel': '#ffffff',
            'paper-bg': '#fffbf2',
            'paper-border': '#e8e4d9'
          }
        }
      }
    }
  </script>

  <!-- Import Map for React and Algolia -->
  <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "algoliasearch/lite": "https://esm.sh/algoliasearch@4.22.1/lite",
    "react-instantsearch": "https://esm.sh/react-instantsearch@7.7.0?external=react,react-dom",
    "lucide-react": "https://esm.sh/lucide-react@0.344.0?external=react",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "algoliasearch/": "https://aistudiocdn.com/algoliasearch@^5.44.0/"
  }
}
</script>
  <link rel="stylesheet" href="style.css">
</head>

<body class="antialiased">
  <div id="root"></div>

  <script type="text/babel" data-type="module">
    import React, { useState, useMemo, useEffect, useRef } from 'react';
    import ReactDOM from 'react-dom/client';
    import algoliasearch from 'algoliasearch/lite';
    import {
      InstantSearch,
      Configure,
      useSearchBox,
      useHits,
      usePagination,
      useStats,
      useRefinementList,
      useCurrentRefinements,
      Highlight,
      Snippet
    } from 'react-instantsearch';
    import {
      Search, Menu, Globe, X, ChevronLeft, ChevronRight,
      BookOpen, ArrowRight, ZoomIn, ZoomOut, Type, Filter, CheckCircle2, Quote, Plus, Library, ArrowDown, AlertTriangle, Sparkles, SpellCheck
    } from 'lucide-react';

    // --- Algolia Client Setup ---
    const APP_ID = '88G4AVERCC';
    const API_KEY = '33b0b484f534b2ae2dac948d588345a6';
    const INDEX_NAME = 'algolia_unified';

    const algoliaClient = algoliasearch(APP_ID, API_KEY);

    // Simple in-memory cache
    const requestCache = new Map();

    const searchClient = {
      ...algoliaClient,
      search(requests) {
        if (requests.every(({ params }) => !params.query && !params.filters && (!params.facets || params.facets.length === 0))) {
          return Promise.resolve({
            results: requests.map(() => ({
              hits: [],
              nbHits: 0,
              nbPages: 0,
              page: 0,
              processingTimeMS: 0,
            })),
          });
        }

        const cacheKey = JSON.stringify(requests);
        if (requestCache.has(cacheKey)) {
          return Promise.resolve(requestCache.get(cacheKey));
        }

        return algoliaClient.search(requests).then((response) => {
          requestCache.set(cacheKey, response);
          return response;
        });
      },
    };

    // --- Components ---

    const Stats = () => {
      const { nbHits, processingTimeMS, results } = useStats();
      if (!results || !results.query) return null;
      return (
        <div className="text-xs text-slate-500 mt-2 flex gap-2">
          <span>النتائج الكلية: <span className="font-bold">{nbHits.toLocaleString('ar-EG')}</span></span>
          <span>(تم البحث في {processingTimeMS}ms)</span>
        </div>
      );
    };

    const CustomPagination = () => {
      const { pages, currentRefinement, refine, isFirstPage, isLastPage, nbHits } = usePagination();
      if (pages.length === 0 || nbHits === 0) return null;

      return (
        <div className="flex flex-wrap items-center gap-1 text-sm font-sans mt-6 select-none justify-center">
          <button
            onClick={() => !isFirstPage && refine(currentRefinement - 1)}
            disabled={isFirstPage}
            className={`px-3 py-1 rounded border ${isFirstPage ? 'text-gray-300 border-transparent cursor-not-allowed' : 'text-wiki-link border-slate-200 hover:bg-slate-100'}`}
          >
            السابق
          </button>
          {pages.map(page => (
            <button
              key={page}
              onClick={() => refine(page)}
              className={`px-3 py-1 rounded border min-w-[32px] ${currentRefinement === page
                ? 'bg-slate-600 text-white border-slate-600 font-bold'
                : 'text-wiki-link border-slate-200 hover:bg-slate-100'
                }`}
            >
              {page + 1}
            </button>
          ))}
          <button
            onClick={() => !isLastPage && refine(currentRefinement + 1)}
            disabled={isLastPage}
            className={`px-3 py-1 rounded border ${isLastPage ? 'text-gray-300 border-transparent cursor-not-allowed' : 'text-wiki-link border-slate-200 hover:bg-slate-100'}`}
          >
            التالي
          </button>
        </div>
      );
    };

    const CustomSearchBox = () => {
      const { query, refine } = useSearchBox();
      const [inputValue, setInputValue] = useState(query || '');
      const [searchMode, setSearchMode] = useState('best');
      const inputRef = useRef(null);

      useEffect(() => {
        if (query !== inputValue && query !== undefined) {
          if (inputValue === '') setInputValue(query);
        }
      }, [query]);

      const buildQuery = (val, mode) => {
        const cleanVal = val.trim();
        if (!cleanVal) return '';

        switch (mode) {
          case 'phrase': return `"${cleanVal}"`;
          case 'and': return cleanVal.split(/\s+/).map(w => `+${w}`).join(' ');
          case 'fuzzy': return cleanVal;
          case 'best': default: return cleanVal;
        }
      };

      const handleSearch = (val, mode) => {
        const finalQuery = buildQuery(val, mode);
        refine(finalQuery);
      };

      const handleSubmit = (e) => {
        e.preventDefault();
        handleSearch(inputValue, searchMode);
      };

      const handleModeChange = (mode) => {
        setSearchMode(mode);
        if (inputValue.trim()) {
          handleSearch(inputValue, mode);
        }
      };

      return (
        <div className="search-container">
          <form onSubmit={handleSubmit} className="search-input-wrapper mb-4">
            <input
              ref={inputRef}
              type="search"
              value={inputValue}
              onChange={(e) => setInputValue(e.currentTarget.value)}
              placeholder="ابحث في الموسوعة التاريخية..."
              className="search-input"
            />
            <button type="submit" className="search-btn">
              <Search className="w-5 h-5" />
            </button>
          </form>

          <div className="flex justify-center flex-wrap gap-4 text-sm mt-4">
            <label className={`cursor-pointer select-none px-3 py-1 rounded-full transition-all ${searchMode === 'best' ? 'bg-blue-100 text-blue-700 font-bold' : 'text-gray-500 hover:bg-gray-100'}`}>
              <input type="radio" name="searchMode" className="hidden" checked={searchMode === 'best'} onChange={() => handleModeChange('best')} />
              <span>بحث ذكي</span>
            </label>
            <label className={`cursor-pointer select-none px-3 py-1 rounded-full transition-all ${searchMode === 'phrase' ? 'bg-blue-100 text-blue-700 font-bold' : 'text-gray-500 hover:bg-gray-100'}`}>
              <input type="radio" name="searchMode" className="hidden" checked={searchMode === 'phrase'} onChange={() => handleModeChange('phrase')} />
              <span>عبارة دقيقة</span>
            </label>
          </div>
        </div>
      );
    };

    const BookFilter = () => {
      const { items, refine } = useRefinementList({
        attribute: 'book_title',
        sortBy: ['count:desc', 'name:asc'],
        limit: 20
      });

      return (
        <div className="mt-2 mb-4">
          <div className="flex items-center justify-end gap-2 mb-2 text-xs text-slate-500">
            <span>اختر الكتاب للبحث فيه:</span>
            <Library className="w-3 h-3" />
          </div>
          <div className="flex flex-wrap justify-end gap-3">
            {items.map((item) => {
              return (
                <button
                  key={item.value}
                  onClick={() => refine(item.value)}
                  className={`
                        group flex items-center gap-3 px-3 py-2 rounded border transition-all
                        ${item.isRefined
                      ? 'bg-white border-wiki-link ring-1 ring-wiki-link shadow-sm'
                      : 'bg-white border-slate-300 hover:border-slate-400 hover:bg-slate-50'}
                    `}
                >
                  <span className="text-xs font-bold text-slate-400 font-mono">({item.count})</span>
                  <span className={`text-sm font-serif ${item.isRefined ? 'text-wiki-link font-bold' : 'text-slate-700'}`}>
                    {item.label}
                  </span>
                  <BookOpen className={`w-4 h-4 ${item.isRefined ? 'text-wiki-link' : 'text-slate-300'}`} />
                </button>
              );
            })}
          </div>
        </div>
      );
    };

    // --- Reader Component with Improved Navigation ---

    const ReaderView = ({ initialHit, onClose }) => {
      const [fontSize, setFontSize] = useState(24);
      const [currentHit, setCurrentHit] = useState(initialHit);
      const [loading, setLoading] = useState(false);
      const contentRef = useRef(null);

      useEffect(() => {
        setCurrentHit(initialHit);
      }, [initialHit]);

      const fetchAdjacentPage = async (direction) => {
        if (loading) return;
        setLoading(true);

        try {
          const currentPart = parseInt(currentHit.part_number, 10);
          const currentPage = parseInt(currentHit.page_number, 10);
          const bookTitle = currentHit.book_title;
          const safeTitle = bookTitle.replace(/"/g, '\\"');

          if (isNaN(currentPart) || isNaN(currentPage)) throw new Error("بيانات الصفحة غير صالحة");

          let targetHit = null;

          // STRATEGY 1: Direct Lookup
          const expectedPage = direction === 'next' ? currentPage + 1 : currentPage - 1;

          if (expectedPage > 0) {
            const directResponse = await algoliaClient.search([{
              indexName: INDEX_NAME,
              params: {
                query: '',
                filters: `book_title:"${safeTitle}" AND part_number=${currentPart} AND page_number=${expectedPage}`,
                hitsPerPage: 5
              }
            }]);

            const candidates = directResponse.results[0].hits;
            if (candidates.length > 0) {
              targetHit = candidates.sort((a, b) => {
                const lenA = a.text_content ? a.text_content.length : 0;
                const lenB = b.text_content ? b.text_content.length : 0;
                return lenB - lenA; // Descending order
              })[0];
            }
          }

          // STRATEGY 2: Range Lookup
          if (!targetHit) {
            const response = await algoliaClient.search([{
              indexName: INDEX_NAME,
              params: {
                query: '',
                filters: `book_title:"${safeTitle}" AND part_number=${currentPart}`,
                numericFilters: [
                  direction === 'next' ? `page_number > ${currentPage}` : `page_number < ${currentPage}`
                ],
                hitsPerPage: 20
              }
            }]);

            const hits = response.results[0].hits;

            if (hits.length > 0) {
              const sortedByPage = hits.sort((a, b) => {
                return direction === 'next'
                  ? a.page_number - b.page_number
                  : b.page_number - a.page_number;
              });
              const closestPageNum = sortedByPage[0].page_number;
              const bestPageCandidates = sortedByPage.filter(h => h.page_number === closestPageNum);
              targetHit = bestPageCandidates.sort((a, b) => {
                const lenA = a.text_content ? a.text_content.length : 0;
                const lenB = b.text_content ? b.text_content.length : 0;
                return lenB - lenA;
              })[0];
            }
          }

          // STRATEGY 3: Adjacent Part
          if (!targetHit) {
            if (direction === 'next') {
              const nextPart = currentPart + 1;
              const partResponse = await algoliaClient.search([{
                indexName: INDEX_NAME,
                params: {
                  query: '',
                  filters: `book_title:"${safeTitle}" AND part_number=${nextPart}`,
                  hitsPerPage: 1,
                }
              }]);

              if (partResponse.results[0].hits.length > 0) {
                targetHit = partResponse.results[0].hits[0];
              }
            } else {
              const prevPart = currentPart - 1;
              if (prevPart >= 1) {
                const partResponse = await algoliaClient.search([{
                  indexName: INDEX_NAME,
                  params: {
                    query: '',
                    filters: `book_title:"${safeTitle}" AND part_number=${prevPart}`,
                    hitsPerPage: 50,
                  }
                }]);
                if (partResponse.results[0].hits.length > 0) {
                  const sorted = partResponse.results[0].hits.sort((a, b) => b.page_number - a.page_number);
                  targetHit = sorted[0];
                }
              }
            }
          }

          if (targetHit) {
            setCurrentHit(targetHit);
            window.scrollTo({ top: 0, behavior: 'smooth' });
          } else {
            if (direction === 'next') alert("وصلت إلى نهاية الكتاب.");
            else alert("هذه بداية الكتاب.");
          }

        } catch (error) {
          console.error("Navigation Error:", error);
          alert("حدث خطأ: " + error.message);
        } finally {
          setLoading(false);
        }
      };

      const formattedText = useMemo(() => {
        if (!currentHit || !currentHit.text_content) return null;
        const rawText = currentHit.text_content;
        const lines = rawText
          .replace(/\|\|/g, '\n')
          .replace(/\.(?=\s|$)/g, '.\n')
          .split('\n');

        return (
          <div className="text-justify">
            {lines.map((line, index) => {
              const trimmedLine = line.trim();
              if (!trimmedLine) return null;
              return <p key={index} className="mb-4 block">{trimmedLine}</p>;
            })}
          </div>
        );
      }, [currentHit]);

      if (!currentHit) return null;

      return (
        <div className="reader-overlay animate-fade-in">
          <div className="reader-toolbar">
            <div className="flex items-center gap-4">
              <button onClick={onClose} className="reader-nav-btn">
                <ArrowRight className="w-5 h-5" />
                <span>عودة</span>
              </button>
              <div className="flex items-center gap-2 mr-4 border-r pr-4">
                <button onClick={() => setFontSize(Math.max(18, fontSize - 2))} className="p-2 hover:bg-gray-100 rounded-full"><ZoomOut className="w-5 h-5" /></button>
                <span className="font-mono text-lg w-8 text-center">{fontSize}</span>
                <button onClick={() => setFontSize(Math.min(48, fontSize + 2))} className="p-2 hover:bg-gray-100 rounded-full"><ZoomIn className="w-5 h-5" /></button>
              </div>
            </div>

            <div className="flex items-center gap-2">
              <button onClick={() => fetchAdjacentPage('prev')} disabled={loading} className="reader-nav-btn">
                <ChevronRight className="w-5 h-5" />
                <span className="hidden sm:inline">السابقة</span>
              </button>
              <div className="text-center mx-4">
                <div className="font-bold text-sm">{currentHit.book_title}</div>
                <div className="text-xs text-gray-500">ج {currentHit.part_number} • ص {currentHit.page_number}</div>
              </div>
              <button onClick={() => fetchAdjacentPage('next')} disabled={loading} className="reader-nav-btn">
                <span className="hidden sm:inline">التالية</span>
                <ChevronLeft className="w-5 h-5" />
              </button>
            </div>
          </div>

          <div className="reader-content" ref={contentRef}>
            {loading && (
              <div className="flex flex-col items-center justify-center py-20">
                <div className="loader"></div>
                <p className="text-gray-500 mt-4">جاري التحميل...</p>
              </div>
            )}

            <div className="reader-text" style={{ fontSize: `${fontSize}px` }}>
              {formattedText}
            </div>

            <div className="mt-16 text-center border-t pt-8">
              <button onClick={() => fetchAdjacentPage('next')} disabled={loading} className="reader-nav-btn mx-auto px-8 py-4 text-lg">
                <span>{loading ? 'جاري الانتقال...' : 'اقرأ الصفحة التالية'}</span>
                {!loading && <ChevronLeft className="w-5 h-5" />}
              </button>
            </div>
          </div>
        </div>
      );
    };

    const HitCard = ({ hit, onClick }) => {
      return (
        <article className="hit-item">
          <div className="hit-meta">
            <BookOpen className="w-4 h-4" />
            <span>{hit.book_title}</span>
            <span className="mx-2">•</span>
            <span>جزء {hit.part_number}</span>
            <span className="mx-2">•</span>
            <span>صفحة {hit.page_number}</span>
          </div>
          <h3 className="hit-title" onClick={onClick}>
            <Highlight attribute="book_title" hit={hit} />
          </h3>
          <div className="hit-snippet">
            <Snippet attribute="text_content" hit={hit} />
          </div>
        </article>
      );
    };

    const AppContent = () => {
      const { hits, results } = useHits();
      const [selectedHit, setSelectedHit] = useState(null);

      const hasSearched = results && results.query && results.query.length > 0;

      // --- DEDUPLICATION LOGIC ---
      const uniqueHits = useMemo(() => {
        const seen = new Set();
        return hits.filter(hit => {
          const key = `${hit.book_title}-${hit.part_number}-${hit.page_number}`;
          if (seen.has(key)) return false;
          seen.add(key);
          return true;
        });
      }, [hits]);

      const handleRead = (hit) => {
        setSelectedHit(hit);
        window.scrollTo({ top: 0, behavior: 'smooth' });
      };

      const handleCloseReader = () => {
        setSelectedHit(null);
      };

      return (
        <div className="min-h-[500px]">
          <div className={selectedHit !== null ? 'hidden' : 'block'}>
            <div className="mb-8">
              <CustomSearchBox />
              {hasSearched && <Stats />}
              <BookFilter />
            </div>

            {!hasSearched ? (
              <div className="py-20 text-center text-gray-500">
                <BookOpen className="w-16 h-16 mx-auto mb-4 text-gray-300" />
                <p className="text-xl mb-2 font-serif">مرحباً بك في الموسوعة التاريخية</p>
                <p className="text-sm">اكتب كلمة البحث في الصندوق أعلاه للبدء في استكشاف آلاف الصفحات.</p>
              </div>
            ) : uniqueHits.length === 0 ? (
              <div className="py-8 text-center text-gray-600 bg-gray-50 rounded-lg">
                <p className="font-bold mb-1">لم يتم العثور على نتائج.</p>
                <p className="text-sm">جرب كلمات مختلفة أو تأكد من الإملاء.</p>
              </div>
            ) : (
              <div className="hits-list">
                {uniqueHits.map((hit) => (
                  <HitCard key={hit.objectID} hit={hit} onClick={() => handleRead(hit)} />
                ))}
              </div>
            )}

            {hasSearched && (
              <div className="mt-10 border-t pt-6 flex justify-center">
                <CustomPagination />
              </div>
            )}
          </div>

          {selectedHit !== null && (
            <ReaderView
              initialHit={selectedHit}
              onClose={handleCloseReader}
            />
          )}
        </div>
      );
    };

    // --- Main Layout ---

    const App = () => {
      return (
        <div className="container-fluid">
          <header className="text-center">
            <div className="flex items-center justify-center gap-3">
              <Globe className="w-8 h-8 text-blue-600" />
              <h1>الموسوعة التاريخية</h1>
              <span className="bg-blue-100 text-blue-800 text-xs font-bold px-2 py-1 rounded-full">v3.0</span>
            </div>
          </header>

          <main>
            <InstantSearch
              searchClient={searchClient}
              indexName={INDEX_NAME}
              future={{ preserveSharedStateOnUnmount: true }}
            >
              <Configure
                hitsPerPage={10}
                attributesToSnippet={['text_content:100']}
                snippetEllipsisText="..."
                advancedSyntax={true}
                facets={['book_title']}
                maxValuesPerFacet={20}
              />
              <AppContent />
            </InstantSearch>
          </main>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>

</html>