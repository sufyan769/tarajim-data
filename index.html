<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>الموسوعة الشاملة - الرئيسية</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=Noto+Naskh+Arabic:wght@400;700&display=swap"
    rel="stylesheet">

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <link rel="stylesheet" href="style.css">
</head>

<body>

  <!-- Unified Navigation -->
  <nav class="main-nav">
    <div class="nav-container">
      <a href="index.html" class="nav-logo">
        <i data-lucide="library"></i>
        <span>الموسوعة الشاملة</span>
      </a>
      <div class="nav-links">
        <a href="hadith.html" class="nav-link">
          <i data-lucide="book-open-check" class="w-4 h-4"></i>
          الحديث الشريف
        </a>
        <a href="scholars.html" class="nav-link">
          <i data-lucide="users" class="w-4 h-4"></i>
          تراجم العلماء
        </a>
        <a href="history.html" class="nav-link">
          <i data-lucide="scroll" class="w-4 h-4"></i>
          البداية والنهاية
        </a>
        <a href="algolia-search.html" class="nav-link">
          <i data-lucide="book" class="w-4 h-4"></i>
          موسوعة الفتاوى
        </a>
        <a href="firebase-search.html" class="nav-link">
          <i data-lucide="database" class="w-4 h-4"></i>
          بحث Firebase
        </a>
      </div>
    </div>
  </nav>

  <main class="simple-shell">
    <section class="search-stack">
      <div class="stack-header">
        <div>
          <p class="eyebrow">محرك موحد</p>
          <h1>ابحث في كل الأقسام من مكان واحد</h1>
          <p class="lead">نتائج من الحديث، التراجم، التاريخ، الفتاوى وقاعدة Firebase مباشرة.</p>
        </div>
        <div class="stack-links">
          <a href="hadith.html">الحديث</a>
          <a href="scholars.html">التراجم</a>
          <a href="history.html">التاريخ</a>
          <a href="algolia-search.html">الفتاوى</a>
          <a href="firebase-search.html">بحث Firebase</a>
        </div>
      </div>

      <div class="search-tabs">
        <button class="search-tab active" data-target="all">الكل</button>
        <button class="search-tab" data-target="hadith">الحديث</button>
        <button class="search-tab" data-target="scholars">التراجم</button>
        <button class="search-tab" data-target="history">التاريخ</button>
        <button class="search-tab" data-target="fatawa">الفتاوى</button>
        <button class="search-tab" data-target="firebase">Firebase</button>
      </div>

      <form id="searchForm" class="search-input-wrapper search-input-wrapper--full">
        <button type="submit" class="search-btn">
          <i data-lucide="search" class="w-6 h-6"></i>
        </button>
        <input id="searchInput" type="text" class="search-input"
          placeholder="ابحث في الموسوعة (مثلاً: البخاري، ابن تيمية، الزكاة)..." autocomplete="off">
      </form>
    </section>

    <section class="results-panel results-panel--tight">
      <div id="loadingState" class="hidden state-card">
        <div class="spinner"></div>
        <p>جاري البحث في المصادر...</p>
      </div>

      <div id="noResultsState" class="hidden state-card">
        <i data-lucide="search-x"></i>
        <div>
          <h3>لم يتم العثور على نتائج</h3>
          <p>حاول استخدام كلمات مختلفة أو تأكد من الإملاء.</p>
        </div>
      </div>

      <div id="resultsList" class="results-list hidden"></div>
    </section>

    <section class="quick-links">
      <p>تحتاج واجهة متقدمة لكل قسم؟ اختر من هنا:</p>
      <div class="quick-links__chips">
        <a href="hadith.html">واجهة الحديث</a>
        <a href="scholars.html">واجهة التراجم</a>
        <a href="history.html">قارئ التاريخ</a>
        <a href="algolia-search.html">موسوعة الفتاوى</a>
        <a href="firebase-search.html">بحث Firebase فقط</a>
      </div>
    </section>
  </main>

  <footer class="site-footer">
    <p>&copy; 2025 الموسوعة الشاملة. جميع الحقوق محفوظة.</p>
  </footer>

  <!-- Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, getDoc, collection, query, where, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import algoliasearch from 'https://cdn.jsdelivr.net/npm/algoliasearch@4.22.1/dist/algoliasearch-lite.esm.browser.js';

    const CONFIG = {
      hadith: {
        appId: '88G4AVERCC',
        apiKey: '76402a5d814264e01fb86ca687d26e30',
        indexName: 'firebase-hadeth',
        firebaseCollection: 'hadiths'
      },
      history: {
        appId: '88G4AVERCC',
        apiKey: '33b0b484f534b2ae2dac948d588345a6',
        indexName: 'algolia_unified'
      },
      scholars: {
        appId: '3XD12I7386',
        apiKey: '981ea91e88c65be8aadf2113c207b9c5',
        indexName: 'trajum'
      },
      fatawa: {
        appId: '3XD12I7386',
        apiKey: '89e8e132a05fdb02275f64dec8d14d05',
        indexName: 'alfatawa'
      },
      firebase: {
        apiKey: "AIzaSyBYJ2pVoWJ5ednWOnnF2dOJ43MJvDi_8rw",
        authDomain: "hadeth-7baf7.firebaseapp.com",
        projectId: "hadeth-7baf7",
        storageBucket: "hadeth-7baf7.firebasestorage.app",
        messagingSenderId: "401684715520",
        appId: "1:401684715520:web:297abdb6aee1fb3176a0e5"
      },
      scholarFirebase: {
        apiKey: "AIzaSyBni4eUpBlMrBVr-I-_bTLDyYpdJgkBnpw",
        authDomain: "islsm-9.firebaseapp.com",
        projectId: "islsm-9",
        storageBucket: "islsm-9.firebasestorage.app",
        messagingSenderId: "940034885206",
        appId: "1:940034885206:web:4013d7a5297f2ff7b41df7"
      }
    };

    const app = initializeApp(CONFIG.firebase);
    const db = getFirestore(app);
    const scholarApp = initializeApp(CONFIG.scholarFirebase, "scholarApp");
    const scholarDb = getFirestore(scholarApp);

    const clients = {
      hadith: algoliasearch(CONFIG.hadith.appId, CONFIG.hadith.apiKey).initIndex(CONFIG.hadith.indexName),
      history: algoliasearch(CONFIG.history.appId, CONFIG.history.apiKey).initIndex(CONFIG.history.indexName),
      scholars: algoliasearch(CONFIG.scholars.appId, CONFIG.scholars.apiKey).initIndex(CONFIG.scholars.indexName),
      fatawa: algoliasearch(CONFIG.fatawa.appId, CONFIG.fatawa.apiKey).initIndex(CONFIG.fatawa.indexName)
    };

    const searchForm = document.getElementById('searchForm');
    const searchInput = document.getElementById('searchInput');
    const searchTabs = document.querySelectorAll('.search-tab');
    const resultsList = document.getElementById('resultsList');
    const loadingState = document.getElementById('loadingState');
    const noResultsState = document.getElementById('noResultsState');

    const PLACEHOLDERS = {
      all: "ابحث في الموسوعة (مثلاً: البخاري، عمر بن الخطاب)...",
      hadith: "ابحث في الأحاديث (مثلاً: إنما الأعمال بالنيات)...",
      history: "ابحث في التاريخ (مثلاً: معركة بدر)...",
      scholars: "ابحث عن عالم (مثلاً: ابن تيمية)...",
      fatawa: "ابحث عن فتوى (مثلاً: زكاة الشركات)...",
      firebase: "ابحث في قاعدة التراجم المخصصة..."
    };

    let currentTab = 'all';

    document.addEventListener('DOMContentLoaded', () => {
      lucide.createIcons();
      const lastResults = sessionStorage.getItem('lastSearchResults');
      const lastTerm = sessionStorage.getItem('lastSearchTerm');
      const lastTab = sessionStorage.getItem('lastActiveTab');

      if (lastResults && lastTerm) {
        searchInput.value = lastTerm;
        if (lastTab) {
          setActiveTab(lastTab);
        }

        try {
          const results = JSON.parse(lastResults);
          if (results.length > 0) {
            loadingState.classList.add('hidden');
            noResultsState.classList.add('hidden');
            resultsList.classList.remove('hidden');
            renderResults(results);
          }
        } catch (e) {
          console.error("Error parsing saved results:", e);
          sessionStorage.removeItem('lastSearchResults');
        }
      }
    });

    function setActiveTab(tab) {
      searchTabs.forEach(t => t.classList.remove('active'));
      const button = Array.from(searchTabs).find(btn => btn.dataset.target === tab);
      if (button) button.classList.add('active');
      currentTab = tab;
      searchInput.placeholder = PLACEHOLDERS[tab] || PLACEHOLDERS.all;
    }

    searchTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        setActiveTab(tab.dataset.target);
        if (searchInput.value.trim()) {
          handleSearch(searchInput.value.trim());
        }
      });
    });

    searchForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const term = searchInput.value.trim();
      if (term) handleSearch(term);
    });

    async function handleSearch(term) {
      resultsList.innerHTML = '';
      resultsList.classList.add('hidden');
      noResultsState.classList.add('hidden');
      loadingState.classList.remove('hidden');

      try {
        let results = [];

        if (currentTab === 'all') {
          const [hadithRes, historyRes, scholarsRes, fatawaRes, firebaseDocs] = await Promise.all([
            clients.hadith.search(term, { hitsPerPage: 5 }),
            clients.history.search(term, { hitsPerPage: 5 }),
            clients.scholars.search(term, { hitsPerPage: 5 }),
            clients.fatawa.search(term, { hitsPerPage: 5 }),
            searchFirebaseDocs(term, 5)
          ]);

          const hydratedHadith = await hydrateHadithResults(hadithRes.hits);
          results = [
            ...formatResults(hydratedHadith, 'hadith'),
            ...formatResults(scholarsRes.hits, 'scholars'),
            ...formatResults(historyRes.hits, 'history'),
            ...formatResults(fatawaRes.hits, 'fatawa'),
            ...formatResults(firebaseDocs, 'firebase')
          ];
        } else if (currentTab === 'firebase') {
          const docs = await searchFirebaseDocs(term, 20);
          results = formatResults(docs, 'firebase');
        } else {
          const client = clients[currentTab];
          if (!client) throw new Error('Client غير موجود');
          const res = await client.search(term, { hitsPerPage: 20 });
          let hits = res.hits;
          if (currentTab === 'hadith') {
            hits = await hydrateHadithResults(hits);
          }
          results = formatResults(hits, currentTab);
        }

        loadingState.classList.add('hidden');

        if (results.length === 0) {
          noResultsState.classList.remove('hidden');
          sessionStorage.setItem('lastSearchResults', JSON.stringify([]));
        } else {
          resultsList.classList.remove('hidden');
          renderResults(results);
          sessionStorage.setItem('lastSearchTerm', term);
          sessionStorage.setItem('lastActiveTab', currentTab);
          sessionStorage.setItem('lastSearchResults', JSON.stringify(results));
        }

      } catch (error) {
        console.error("Search Error:", error);
        loadingState.classList.add('hidden');
        resultsList.innerHTML = `<p class="text-center text-red-500">حدث خطأ أثناء البحث. يرجى المحاولة مرة أخرى.</p>`;
        resultsList.classList.remove('hidden');
      }
    }

    async function hydrateHadithResults(hits) {
      const promises = hits.map(async (hit) => {
        try {
          const docRef = doc(db, CONFIG.hadith.firebaseCollection, hit.objectID);
          const docSnap = await getDoc(docRef);
          if (docSnap.exists()) {
            return { ...hit, ...docSnap.data() };
          }
          return hit;
        } catch (e) {
          console.error("Error hydrating hadith:", hit.objectID, e);
          return hit;
        }
      });
      return Promise.all(promises);
    }

    function formatResults(hits, type) {
      return hits.map(hit => {
        let title = '';
        let snippet = '';
        let link = '#';
        let meta = '';

        if (type === 'hadith') {
          title = hit.text ? hit.text.substring(0, 100) + "..." : "حديث شريف";
          snippet = hit.text || "";
          link = `details_hadith.html?id=${hit.objectID}`;
          let hukmBadge = '';
          if (hit.hukm) {
            const h = Array.isArray(hit.hukm) ? hit.hukm[0] : hit.hukm;
            let colorClass = 'badge-info';
            if (h.includes('صحيح')) colorClass = 'badge-success';
            if (h.includes('ضعيف') || h.includes('موضوع')) colorClass = 'badge-danger';
            hukmBadge = `<span class="badge ${colorClass}">${h}</span>`;
          }
          const source = hit.source ? (Array.isArray(hit.source) ? hit.source[0] : hit.source) : '';
          const rawi = hit.rawi ? (Array.isArray(hit.rawi) ? hit.rawi[0] : hit.rawi) : '';
          meta = `
            <div class="flex flex-wrap gap-2 items-center">
                ${hukmBadge}
                ${source ? `<span class="text-xs text-blue-600 bg-blue-50 px-2 py-1 rounded">${source}</span>` : ''}
                ${rawi ? `<span class="text-xs text-brown font-bold">الراوي: ${rawi}</span>` : ''}
            </div>
          `;
        } else if (type === 'scholars') {
          title = hit.name || "بطاقة تراجم";
          snippet = hit.trj ? hit.trj.substring(0, 200) + "..." : "";
          const docId = hit.objectID || hit.id;
          link = `details_scholars.html?id=${docId}`;
          meta = `<span class="badge badge-info">تراجم</span> ${hit.death ? 'توفي: ' + hit.death : ''}`;
        } else if (type === 'history') {
          title = hit.name || "بدون عنوان";
          const content = hit.full_intro || hit.text || "";
          snippet = content.substring(0, 200) + "...";
          link = `history.html?id=${hit.objectID}`;
          meta = `<span class="badge badge-warning">تاريخ</span>`;
        } else if (type === 'fatawa') {
          title = hit.question || "فتوى";
          const answerPreview = hit.answer || hit.answer_snippet || hit.text || "";
          snippet = answerPreview.substring(0, 220) + "...";
          const src = hit.source || '';
          link = src ? `/fatwa_pages/${src}` : '#';
          meta = `<span class="badge badge-info">فتوى</span> ${hit.source ? hit.source.replace('.html', '') : ''}`;
        } else if (type === 'firebase') {
          title = hit.name || "سيرة معرفية";
          const content = hit.trj || hit.summary || "";
          snippet = content.substring(0, 220) + "...";
          const docId = hit.id || hit.objectID;
          link = `details_scholars.html?id=${docId}`;
          meta = `<span class="badge badge-success">قاعدة Firebase</span> ${hit.death ? 'توفي: ' + hit.death : ''}`;
        }

        return { type, title, snippet, link, meta, raw: hit };
      });
    }

    function renderResults(results) {
      resultsList.innerHTML = '';
      results.forEach(item => {
        const div = document.createElement('div');
        div.className = 'result-item';
        div.innerHTML = `
          <div class="result-meta">${item.meta}</div>
          <h3 class="result-title">
            <a href="${item.link}">${item.title}</a>
          </h3>
          <div class="result-snippet">${item.snippet}</div>
        `;
        resultsList.appendChild(div);
      });
    }

    async function searchFirebaseDocs(term, size = 10) {
      if (!term) return [];
      const trimmed = term.trim();
      const colRef = collection(scholarDb, "scholars_biographies");
      let snapshot = await getDocs(query(colRef, where("aliases", "array-contains", trimmed), limit(size)));

      if (snapshot.empty && trimmed.includes(' ')) {
        const fallback = trimmed.split(' ')[0];
        if (fallback.length >= 3) {
          snapshot = await getDocs(query(colRef, where("aliases", "array-contains", fallback), limit(size)));
        }
      }

      return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    }

    function normalizeResultUrl(url) {
      if (!url) return '';
      try {
        const parsed = new URL(url, window.location.origin);
        if (parsed.hostname.includes('your-site.com')) {
          return parsed.pathname + parsed.search + parsed.hash;
        }
        return url;
      } catch {
        return url;
      }
    }

  </script>
</body>

</html>
